# Implementation Plan: Enhanced Sequence Diagram Syntax Support

**Branch**: `002-title-alias-support` | **Date**: 2025-11-07 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-title-alias-support/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command following the specification-driven development workflow.

## Summary

Verify and enhance testing for Title, participant aliasing, and participant ordering syntax in the existing SQJS plugin. Research confirms that js-sequence-diagrams v2.0.1 **natively supports all three features**. The existing plugin already passes Title syntax through (evidence: test fixtures use `Title: Authentication Flow`). This feature focuses on comprehensive testing, validation, and documentation to ensure these syntax elements work correctly and provide helpful error messages when misused.

## Technical Context

**Language/Version**: TypeScript 5.x (existing plugin infrastructure)
**Primary Dependencies**:
  - js-sequence-diagrams@2.0.1 (already bundled - supports Title, participant alias, participant ordering natively)
  - Existing SQJS plugin infrastructure (DiagramParser, DiagramRenderer, ErrorDisplay)

**Storage**: Plugin settings via Obsidian's data.json (no new storage requirements)
**Testing**: Vitest with happy-dom (existing test infrastructure)
**Target Platform**: Obsidian Desktop (Windows, macOS, Linux) - Electron-based application
**Project Type**: Enhancement to existing single Obsidian plugin project

**Performance Goals**:
  - Same as baseline: <2s render time for diagrams with ≤10 participants and ≤20 messages
  - No performance degradation from syntax validation
  - Title parsing adds negligible overhead (<10ms)

**Constraints**:
  - Backward compatibility: existing diagrams without Title/participant syntax must continue to work
  - Library pass-through: must not modify js-sequence-diagrams library parsing logic
  - Read-only: never modify note content
  - Performance parity: no degradation from existing rendering performance

**Scale/Scope**:
  - Enhancement to existing feature (001-sqjs-renderer)
  - Adds validation and tests for 3 syntax elements already supported by library
  - Estimated 15-20 new test cases
  - Minor updates to DiagramParser for validation
  - Documentation updates to README and quickstart

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Verification Checklist** (from constitution v1.0.0):

- [x] **Plugin-First Architecture**: ✅ PASS - Enhancement to existing plugin infrastructure. Maintains single plugin module design with no new architectural components. All functionality contained within existing DiagramParser and test suite.

- [ ] **Test-First Development**: ⏸️ DEFERRED - Test task ordering will be verified during `/speckit.tasks` generation. Specification includes testable acceptance criteria for all 3 user stories with clear test scenarios.

- [x] **Specification-Driven**: ✅ PASS - Complete spec.md exists with 3 prioritized user stories (P1: Titles, P2: Aliases, P3: Ordering), 15 functional requirements, 7 success criteria, 7 edge cases, and assumptions documented.

- [x] **Complexity Justification**: ✅ PASS - No complexity violations. Enhancement leverages existing plugin infrastructure and library capabilities. No new abstractions or architectural layers required.

**Gate Status**: ✅ PASS - Proceed to Phase 0 research

**Notes**:
- This is primarily a **verification and testing** enhancement
- Title syntax already in use in test fixtures (sample-diagrams.ts:10)
- All three features are natively supported by js-sequence-diagrams v2.0.1
- Focus is on validation, error handling, and comprehensive test coverage

## Project Structure

### Documentation (this feature)

```text
specs/002-title-alias-support/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (library syntax capabilities)
├── data-model.md        # Phase 1 output (validation entities)
├── quickstart.md        # Phase 1 output (developer guide)
├── contracts/           # Phase 1 output (validation interfaces)
└── tasks.md             # Phase 2 output (/speckit.tasks command)
```

### Source Code (existing repository structure - NO NEW DIRECTORIES)

```text
src/
├── processors/
│   └── DiagramParser.ts         # ENHANCE: Add Title/participant validation
├── renderer/
│   ├── DiagramRenderer.ts       # NO CHANGES: Library handles rendering
│   └── ErrorDisplay.ts          # ENHANCE: Add syntax error messages
├── utils/
│   └── (no new files)           # Existing utilities unchanged
└── types.ts                     # ENHANCE: Add validation types if needed

tests/
├── integration/
│   ├── rendering.test.ts        # ENHANCE: Add Title rendering tests
│   ├── error-handling.test.ts   # ENHANCE: Add syntax validation tests
│   └── (new) syntax-features.test.ts  # NEW: Title/alias/ordering tests
├── unit/
│   └── DiagramParser.test.ts    # ENHANCE: Add validation unit tests
└── fixtures/
    └── sample-diagrams.ts       # ENHANCE: Add Title/alias examples
```

**Structure Decision**: This is an enhancement to the existing plugin (001-sqjs-renderer). No new source directories required. Changes are confined to:
1. DiagramParser validation logic (detect malformed Title/participant syntax)
2. ErrorDisplay messages (helpful errors for syntax mistakes)
3. Test suite expansion (verify correct rendering and error handling)
4. Test fixtures (examples of Title, alias, ordering syntax)

## Complexity Tracking

> **No violations** - This section is empty because all Constitution checks passed.

This enhancement maintains the existing single-plugin architecture with no additional complexity.

---

## Phase 0: Research (Completed)

**Status**: ✅ COMPLETED

### Research Findings

#### 1. js-sequence-diagrams v2.0.1 Native Support

**Research Question**: Does the bundled library support Title, participant alias, and ordering syntax natively?

**Answer**: ✅ YES - All three features are **core grammar elements** in v2.0.1

**Evidence**:
- Grammar definition (`/src/grammar.jison`) includes:
  - `'title' ':'? message` (Title with optional colon)
  - `'participant' actor_alias` (Participant with optional alias)
  - Participant order determined by declaration sequence
- Test gallery (`/test/gallery.html`) demonstrates all three features
- Official demo site shows working examples

**Syntax Examples from Library**:

```
# Title (case-insensitive, colon optional)
Title: Here is a title
title: System Interaction
title My Title

# Participant Alias
participant Alice as A
participant "Long Name" as C
participant B  # No alias

# Participant Ordering
participant C
participant B
participant A
# Renders left-to-right: C, B, A
```

#### 2. Current Plugin Support Status

**Investigation**: Check existing plugin implementation for Title/participant handling

**Findings**:
- ✅ Title syntax **already used** in test fixtures (`COMPLEX_DIAGRAM` line 10)
- ✅ Plugin passes all syntax directly to library (no preprocessing)
- ✅ Library handles parsing and rendering natively
- ⚠️ No explicit validation for malformed Title/participant syntax
- ⚠️ No dedicated tests for Title, alias, or ordering features
- ⚠️ Error messages from library may be cryptic for syntax errors

**Conclusion**: Features work but lack validation and comprehensive testing.

#### 3. Validation Requirements

**Research Question**: What validation should the plugin perform?

**Decision**: **Minimal validation** - Trust library parser, add helpful pre-checks

**Rationale**:
- Library parser is authoritative for syntax correctness
- Plugin should catch **obvious errors** before library parsing:
  - Unclosed quotes in participant aliases
  - Empty Title declarations (`Title:   ` with only whitespace)
  - Multiple Title declarations (warn user, use first)
- Plugin should **enhance error messages** from library for common mistakes

**Validation Strategy**:
1. Pre-parse checks in DiagramParser for common syntax errors
2. Enhance error messages from library with context
3. Add specific error codes for Title/participant issues

#### 4. Backward Compatibility

**Research Question**: Will this enhancement break existing diagrams?

**Answer**: ✅ NO - Full backward compatibility guaranteed

**Reasoning**:
- Diagrams without Title/participant syntax continue to work (library default behavior)
- Existing diagrams with Title already work (feature 001 test fixtures prove this)
- Adding validation is non-breaking (only enhances error messages)
- No changes to rendering logic (library handles all rendering)

**Evidence**: Feature 001 has diagrams with and without titles, all render correctly.

#### 5. Error Message Enhancement

**Research Question**: What error messages need improvement?

**Library Error Examples** (cryptic):
```
Error: Unexpected token on line X
Error: Parse error on line X
```

**Enhanced Error Messages** (helpful):
```
Syntax Error (Line X): Unclosed quote in participant alias
  participant "User Database
              ^
  Expected closing quote (") before end of line

Syntax Error (Line X): Empty title declaration
  Title:
  ^
  Title cannot be empty. Either provide text or remove the Title: line
```

**Decision**: DiagramParser will detect patterns and provide enhanced messages.

---

## Phase 1: Design (Completed)

**Status**: ✅ COMPLETED

### Data Model

See [data-model.md](./data-model.md) for complete entity definitions.

**Key Entities**:
1. **TitleValidation**: Result of Title syntax validation
2. **ParticipantValidation**: Result of participant/alias syntax validation
3. **SyntaxWarning**: Non-fatal issues (empty title, multiple titles)

### Contracts

See [contracts/](./contracts/) directory for interface definitions.

**New/Enhanced Interfaces**:
1. **ISyntaxValidator**: Title and participant syntax validation
2. **IErrorDisplay** (enhanced): New error message formats for syntax issues

### Quickstart Guide

See [quickstart.md](./quickstart.md) for developer workflow.

**Key Sections**:
1. Testing Title syntax rendering
2. Testing participant alias resolution
3. Testing participant ordering
4. Validation error scenarios

### Constitution Check (Post-Design)

**Re-verification after design phase**:

- [x] **Plugin-First**: ✅ PASS - No new plugin modules. Enhancement to existing DiagramParser and test suite.
- [ ] **Test-First**: ⏸️ VERIFIED IN TASKS - Will be enforced in `/speckit.tasks` phase
- [x] **Specification-Driven**: ✅ PASS - All design artifacts trace to spec.md requirements
- [x] **Complexity**: ✅ PASS - No new complexity introduced

**Final Gate Status**: ✅ PASS - Ready for `/speckit.tasks` generation

---

## Phase 2: Task Generation

**Status**: ⏸️ PENDING - Run `/speckit.tasks` to generate tasks.md

This phase will create the detailed task breakdown organized by user story:
- **User Story 1 (P1)**: Title syntax tests and validation
- **User Story 2 (P2)**: Participant alias tests and validation
- **User Story 3 (P3)**: Participant ordering tests and validation

Each story will follow TDD:
1. Write tests first (verify they fail)
2. Implement validation/enhancement
3. Verify tests pass
4. Refactor while keeping tests green

---

## Summary for Next Phase

**What's Ready**:
- ✅ Feature spec approved (spec.md)
- ✅ Research complete (all syntax supported by library v2.0.1)
- ✅ Design complete (data-model.md, contracts/, quickstart.md)
- ✅ Constitution compliance verified

**Next Command**: `/speckit.tasks`

**Expected Task Count**: ~40-50 tasks
- 10 setup/foundational tasks (test fixtures, validation infrastructure)
- 8-10 tasks per user story (3-4 tests + 4-6 implementation tasks each)
- 8-10 polish tasks (documentation, cross-platform testing)

**MVP Scope**: User Story 1 (Title syntax) - delivers immediate value with diagram labels.

**Key Implementation Notes**:
1. This is primarily a **testing and validation** enhancement
2. Library already supports all syntax - plugin just needs to validate and test
3. Focus on helpful error messages for common mistakes
4. Maintain 100% backward compatibility with existing diagrams
