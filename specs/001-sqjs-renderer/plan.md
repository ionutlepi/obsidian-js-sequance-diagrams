# Implementation Plan: SQJS Sequence Diagram Renderer

**Branch**: `001-sqjs-renderer` | **Date**: 2025-10-30 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-sqjs-renderer/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command following the specification-driven development workflow.

## Summary

Build an Obsidian plugin that detects and renders sequence diagrams from `sqjs` code blocks using the js-sequence-diagrams library. The plugin bundles the rendering library for offline-first operation, supports multiple themes (simple, hand-drawn), provides clear error messaging, and handles edge cases like empty blocks and large diagrams with performance warnings.

## Technical Context

**Language/Version**: TypeScript 5.x (required for Obsidian plugin development)
**Primary Dependencies**:
  - Obsidian Plugin API (^1.0.0)
  - js-sequence-diagrams (bundled) - NEEDS CLARIFICATION: specific version and bundling strategy
  - Raphaël.js (dependency of js-sequence-diagrams) - NEEDS CLARIFICATION: bundling approach
  - Webpack or esbuild for bundling - NEEDS CLARIFICATION: build tool selection

**Storage**: Plugin settings stored via Obsidian's data.json (theme preferences, configuration)

**Testing**: NEEDS CLARIFICATION: Testing framework selection (Jest, Vitest, or Obsidian's testing utilities)

**Target Platform**: Obsidian Desktop (Windows, macOS, Linux) - Electron-based application

**Project Type**: Single Obsidian plugin project

**Performance Goals**:
  - <2 seconds render time for diagrams with ≤10 participants and ≤20 messages
  - <3 seconds theme change propagation across 100+ notes
  - Zero performance degradation after 10 edit/reading mode switches

**Constraints**:
  - Offline-first (library must be bundled, no CDN)
  - Read-only (never modify note content)
  - Non-blocking UI (rendering must not freeze Obsidian)
  - Obsidian API 1.0.0+ compatibility

**Scale/Scope**:
  - Support 1-5 diagrams per note (typical usage)
  - Handle up to 50+ participants/messages with degraded performance warning
  - Plugin size target: <500KB (including bundled library)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Verification Checklist** (from constitution v1.0.0):

- [x] **Plugin-First Architecture**: ✅ PASS - Feature is designed as a single, independent Obsidian plugin module with clear boundaries. Plugin follows Obsidian's plugin system architecture with well-defined entry point, settings UI, and reading mode processor integration.

- [ ] **Test-First Development**: ⏸️ DEFERRED - Test task ordering will be verified during `/speckit.tasks` generation. Specification includes testable acceptance criteria for all user stories.

- [x] **Specification-Driven**: ✅ PASS - Complete spec.md exists with 3 prioritized user stories, 18 functional requirements, 8 success criteria, documented edge cases, and clarification session resolving 5 critical ambiguities.

- [x] **Complexity Justification**: ✅ PASS - No complexity violations detected. Single plugin architecture with no unnecessary abstraction layers.

**Gate Status**: ✅ PASS - Proceed to Phase 0 research

**Notes**:
- Test-First compliance will be enforced during task generation
- Plugin follows standard Obsidian plugin patterns (no custom complexity)
- All requirements trace to user stories in spec.md

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
obsidian-sequancejs/
├── src/
│   ├── main.ts                 # Plugin entry point
│   ├── settings.ts              # Settings tab and configuration
│   ├── renderer/
│   │   ├── DiagramRenderer.ts   # Core rendering logic
│   │   ├── ThemeManager.ts      # Theme switching and style management
│   │   └── ErrorDisplay.ts      # Error message formatting and display
│   ├── processors/
│   │   ├── SQJSCodeBlockProcessor.ts  # Reading mode processor
│   │   └── DiagramParser.ts     # Syntax validation and parsing
│   ├── utils/
│   │   ├── RenderCancellation.ts  # Render operation cancellation
│   │   └── ComplexityAnalyzer.ts  # Participant/message counting
│   └── lib/
│       └── js-sequence-diagrams/  # Bundled library files
│
├── tests/
│   ├── integration/
│   │   ├── rendering.test.ts     # End-to-end rendering tests
│   │   ├── theme-switching.test.ts
│   │   └── error-handling.test.ts
│   ├── unit/
│   │   ├── DiagramRenderer.test.ts
│   │   ├── DiagramParser.test.ts
│   │   └── ComplexityAnalyzer.test.ts
│   └── fixtures/
│       └── sample-diagrams.ts   # Test diagram syntax samples
│
├── manifest.json               # Obsidian plugin manifest
├── package.json
├── tsconfig.json
├── esbuild.config.mjs          # Build configuration
└── .gitignore
```

**Structure Decision**: Single Obsidian plugin project structure following standard plugin conventions. The `src/` directory organizes code by functional area (rendering, processing, utilities) with bundled library in `src/lib/`. Tests are organized by type (integration, unit) with shared fixtures. Build artifacts (main.js, manifest.json) will be generated in root for Obsidian compatibility.

## Complexity Tracking

> **No complexity violations - section not applicable**

The plugin follows standard Obsidian plugin architecture with no unnecessary complexity. All design decisions align with plugin-first principles and Obsidian best practices.

---

## Phase 0: Research (Completed)

**Status**: ✅ Complete

**Artifacts Generated**:
- `research.md`: All NEEDS CLARIFICATION items resolved

**Key Decisions**:
1. js-sequence-diagrams v2.0.1 (with bundled Raphaël.js)
2. esbuild for bundling (Obsidian recommended)
3. Vitest + @testing-library/dom for testing
4. TypeScript 5.x targeting ES2018

**Outcome**: All technical unknowns resolved, implementation approach validated

---

## Phase 1: Design (Completed)

**Status**: ✅ Complete

**Artifacts Generated**:
1. `data-model.md`: 7 core entities with attributes, validation rules, and relationships
2. `contracts/`: 5 TypeScript interface contracts defining component APIs
3. `quickstart.md`: Developer setup guide and implementation workflow

**Key Design Elements**:
- **Entities**: PluginSettings, DiagramSource, DiagramMetrics, RenderResult, RenderError, RenderOperation, DiagramCache
- **Contracts**: IDiagramRenderer, IThemeManager, IErrorDisplay, ISQJSCodeBlockProcessor, IClipboardHandler
- **Architecture**: Plugin-first with clear component boundaries, contract-based integration

**Constitution Re-Check** (Post-Design):

- [x] **Plugin-First Architecture**: ✅ PASS - Design confirms single plugin architecture with 5 well-defined contracts. No unnecessary abstraction. Components integrate via interfaces following Obsidian patterns.

- [x] **Test-First Development**: ✅ READY - Contracts define testable interfaces. Quickstart.md documents TDD workflow. Data model includes validation rules for test coverage.

- [x] **Specification-Driven**: ✅ PASS - All 18 functional requirements trace to contracts. Data entities map to spec Key Entities. Design decisions documented in research.md.

- [x] **Complexity Justification**: ✅ PASS - Design maintains simplicity. 7 entities, 5 contracts, no over-engineering. All complexity justified by functional requirements.

**Final Gate Status**: ✅ PASS - Ready for `/speckit.tasks`

**Outcome**: Design complete, architecture validated, ready for task generation

---

## Next Steps

Run `/speckit.tasks` to generate implementation tasks organized by user story priority.
